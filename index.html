<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:,"> <title>Quote Cache Pro</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #1a1a1a; color: #eee; margin: 0; }
        #card { background: #2a2a2a; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; max-width: 450px; text-align: center; }
        h2 { font-size: 1.5rem; margin-bottom: 10px; line-height: 1.4; }
        p { color: #aaa; font-style: italic; margin-bottom: 25px; }
        .controls { display: flex; gap: 10px; justify-content: center; }
        button { background: #444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        button:hover { background: #666; }
        button.primary { background: #3498db; }
        button.primary:hover { background: #2980b9; }
        #status { display: block; margin-top: 15px; font-size: 0.7rem; color: #555; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="card">
    <h2 id="quote-text">Loading...</h2>
    <p id="quote-author"></p>
    <div class="controls">
        <button class="primary" onclick="cycleQuote()">Next Quote</button>
        <button onclick="copyToClipboard()">Copy</button>
    </div>
    <span id="status">Checking cache...</span>
</div>
<script>
async function cycleQuote() {
    const now = new Date().getTime();
    let cache = JSON.parse(localStorage.getItem('quoteCache'));

    if (!cache || (now - cache.lastFetched) > EXPIRY_TIME) {
        document.getElementById('status').innerText = "Syncing with AWS...";
        try {
            const response = await fetch(LAMBDA_ENDPOINT);
            let newData = await response.json();
            
            // --- DATA CLEANER STEP ---
            // If Lambda nests the data (common in some AWS setups), 
            // we grab the array wherever it is.
            const quotesArray = Array.isArray(newData) ? newData : (newData.quotes || newData.body || []);

            if (quotesArray.length === 0) throw new Error("No quotes found in response");

            cache = {
                quotes: quotesArray,
                currentIndex: 0,
                lastFetched: now
            };
        } catch (err) {
            console.error("Fetch failed:", err);
            document.getElementById('status').innerText = "Using backup quote";
            if (!cache) {
                document.getElementById('quote-text').innerText = "Keep moving forward.";
                document.getElementById('quote-author').innerText = "- Walt Disney";
                return;
            }
        }
    }

    // Double check that 'current' exists before displaying
    const current = cache.quotes[cache.currentIndex];
    
    if (current && current.q) {
        document.getElementById('quote-text').innerText = `"${current.q}"`;
        document.getElementById('quote-author').innerText = `- ${current.a || "Unknown"}`;
        document.getElementById('status').innerText = `Last Sync: ${new Date(cache.lastFetched).toLocaleTimeString()}`;
        
        cache.currentIndex = (cache.currentIndex + 1) % cache.quotes.length;
        localStorage.setItem('quoteCache', JSON.stringify(cache));
    } else {
        // If data is still weird, clear cache to try again
        localStorage.removeItem('quoteCache');
        document.getElementById('status').innerText = "Error: Bad data format. Retrying...";
    }
}
</script>
</body>
</html>